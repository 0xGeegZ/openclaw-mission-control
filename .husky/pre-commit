#!/bin/sh
set -e

# Husky pre-commit hook for OpenClaw Mission Control
# Runs lint, typecheck, and tests on staged changes
# Blocks commit if any check fails

if ! command -v npx &> /dev/null; then
  echo "âŒ npx not found. Please ensure Node.js is installed."
  exit 1
fi

echo "ğŸ” Step 1: Running lint-staged on staged changes..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed. Please fix errors and try again."
  exit 1
fi

echo "âœ… Linting passed"

echo ""
echo "ğŸ” Step 2: Running TypeScript compiler check..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript compilation failed. Please fix type errors and try again."
  exit 1
fi

echo "âœ… TypeScript check passed"

echo ""
echo "ğŸ” Step 3: Running unit tests..."
npm run test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix failing tests and try again."
  exit 1
fi

echo "âœ… All tests passed"
echo ""
echo "âœ… All pre-commit checks passed! Commit allowed."
